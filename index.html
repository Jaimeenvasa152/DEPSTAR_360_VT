<head>
    <!-- for optimal display on high DPI devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core@5/index.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/markers-plugin@5/index.css" />
    <link rel="stylesheet" href="style.css" />
</head>

<!-- the viewer container must have a defined size
<div id="viewer" style="width: 100vw; height: 100vh;"></div> -->


<head>
    <!-- for optimal display on high DPI devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core@5/index.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/markers-plugin@5/index.css" />
    <link rel="stylesheet" href="style.css" />
</head>

<custom-marker id="custom-marker-element-depstar-info" style="display: run-in">
    <h2>Welcome to DEPSTAR</h2>
    <p>Devang Patel Institute of Advance Technology and Research (DEPSTAR) is a constituent of CHARUSAT. The institute is managed through a think tank of technocrats, administrators, scientists and engineers, educationalists, businessmen, stakeholders and other well-wishers from all parts of the world. DEPSTAR is patronized by IPCO Industries, headed by Philanthropist and Industrialist Shri Devang Patel. The institute envisions being a forerunner in teaching and research in advanced technologies. For this, in years to come, it will be an institute with advanced infrastructure, distinguished faculty, networking with global institutes and implementing most modern processes. DEPSTAR has total intake of 300 Seats with Computer Engineering (120 seats), Computer Science & Engineering (120 seats) and Information Technology (60 seats). The average experience of faculties is more than 6 years in Teaching, Industry and Research Domain.</p>
</custom-marker>




<!-- the viewer container must have a defined size -->
<div id="viewer" style="width: 100%; height: 100%;"></div>


<script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js",
            "@photo-sphere-viewer/core": "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core/index.module.js",
            "@photo-sphere-viewer/virtual-tour-plugin": "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/virtual-tour-plugin@5/index.module.js",
            "@photo-sphere-viewer/gallery-plugin": "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/gallery-plugin@5/index.module.js",
            "@photo-sphere-viewer/markers-plugin": "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/markers-plugin@5/index.module.js"
        }
    }
</script>

<script type="module">
    
    import { Viewer } from '@photo-sphere-viewer/core';
    import { VirtualTourPlugin } from '@photo-sphere-viewer/virtual-tour-plugin';
    import { MarkersPlugin } from '@photo-sphere-viewer/markers-plugin';

    const baseUrl = '/img/d.gif';
    // const caption = 'Cape Florida Light, Key Biscayne <b>&copy; Pixexid</b>';

    // Declare the custom marker element
    class CustomMarkerElement extends HTMLElement {
    constructor() {
        super();
        this.fmt = new Intl.NumberFormat({ maximumSignificantDigits: 4 });
        const dom = this.attachShadow({ mode: 'closed' });

        const style = document.createElement('style');
        style.textContent = `
            :host {
                display: block;
                position: relative;
                width: 50px;
                height: 50px;
            }
            button {
                width: 100%;
                height: 100%;
                padding: 0;
                border: none;
                background: none;
                color: white;
                border-radius: 100%;
                filter: drop-shadow(0 10px 5px rgba(0, 0, 0, 0.2));
            }
            button svg {
                width: 100%;
                height: 100%;
            }
            .tooltip {
                box-sizing: border-box;
                width: 300px;
                position: absolute;
                bottom: calc(100% + 10px);
                left: calc(50% -  150px);
                background: rgba(30, 30, 30, 0.8);
                color: white;
                text-shadow: 0 1px #000;
                border-radius: 10px;
                transform-origin: 50% calc(100% + 35px);
                transform: rotate(30deg);
                opacity: 0;
            }
            .tooltip.bottom {
                bottom: auto;
                top: calc(100% + 10px);
                transform-origin: 50% -35px;
            }
            .tooltip.hovered {
                animation: rotate-bounce-out 200ms ease forwards;
            }
            .tooltip slot::slotted(img) {
                width: 100%;
                border-radius: 10px 10px 0 0;
            }
            .tooltip slot::slotted(h2),
            .tooltip slot::slotted(p) {
                margin: 1rem;
                text-align: justify;
            }
            .tooltip pre {
                font-size: 0.8em;
                margin: 1rem;
            }
            .tooltip::after {
                content: '';
                width: 0px;
                height: 0px;
                color: rgba(30, 30, 30, 0.8);
                border: 10px solid transparent;
                border-top-color: currentColor;
                position: absolute;
                top: 100%;
                left: 50%;
                margin-left: -10px;
            }
            .tooltip.bottom::after {
                border-top-color: transparent;
                border-bottom-color: currentColor;
                top: auto;
                bottom: 100%;
            }
            button:hover {
                animation: ripple 1s ease-out;
            }
            .tooltip.hiding {
                animation: hide 200ms ease forwards;
            }
            button:hover + .tooltip {
                animation: show 300ms ease forwards;
            }
            @keyframes ripple {
                0% { box-shadow: 0 0 0 0 rgba(97, 170, 242, 0); }
                20% { box-shadow: 0 0 0 5px rgba(97, 170, 242, 1); }
                100% { box-shadow: 0 0 0 20px rgba(97, 170, 242, 0); }
            }
            @keyframes show {
                0% { transform: rotate(30deg); opacity: 0; }
                70% { transform: rotate(-10deg); }
                100% { transform: rotate(0deg); opacity: 1; }
            }
            @keyframes hide {
                0% { transform: rotate(0deg); opacity: 1; }
                100% { transform: rotate(30deg); opacity: 0; }
            }
                    `;
                    dom.appendChild(style);

                    const button = document.createElement('button');

                    button.innerHTML = `
                            <img src="/img/i.png" alt="Info" style="width: 100%; height: 100%; object-fit: contain;" />
                    `;


        dom.appendChild(button);

        this.tooltip = document.createElement('div');
        this.tooltip.classList.add('tooltip');
        dom.appendChild(this.tooltip);
        this.tooltip.innerHTML = '<slot></slot>';

        this.legend = document.createElement('pre');
        this.tooltip.appendChild(this.legend);

        button.addEventListener('mouseleave', () => {
            this.tooltip.classList.add('hiding');
        });

        dom.addEventListener('animationend', () => {
            this.tooltip.classList.remove('hiding');
        });
    }

    updateMarker({ marker, position, viewerPosition, zoomLevel, viewerSize }) {
        this.legend.innerText = `Params
position: ${position.x}px x ${position.y}px
viewerPosition: ${this.fmt.format(viewerPosition.yaw)}rad / ${this.fmt.format(viewerPosition.pitch)}rad
zoomLevel: ${zoomLevel}%
viewerSize: ${viewerSize.width}px x ${viewerSize.height}px
`;
        this.tooltip.classList.toggle('bottom', position.y < viewerSize.height / 3);
    }
}


    // Register the custom element
    customElements.define('custom-marker', CustomMarkerElement);

    const viewer = new Viewer({
        container: document.querySelector('#viewer'),
        panorama: '/img/1.jpg',
        loadingImg: baseUrl,
        touchmoveTwoFingers: true,
        defaultYaw: '0deg',
        plugins: [
            [VirtualTourPlugin, {
                renderMode: '3d',
                transitionOptions: {
                    fadeIn: true,
                    rotation: true,
                    showLoader: false,
                    speed: "10rpm",
                    zoomTo: 0,
                }
            }], 
            MarkersPlugin, 
        ],
    });
    
    const virtualTour = viewer.getPlugin(VirtualTourPlugin);

    // Add scenes list toggle button
    const scenesListButton = document.createElement('button');
    scenesListButton.className = 'scenes-list-button';
    scenesListButton.innerHTML = `
        <svg viewBox="0 0 24 24" width="24" height="24">
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" fill="currentColor"/>
        </svg>
    `;
    document.body.appendChild(scenesListButton);

    // Add styles for the scenes list
    const style = document.createElement('style');
    style.textContent = `
        .scenes-list-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .scenes-list {
            position: fixed;
            top: 70px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 15px;
            max-width: 300px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
        }
        .scenes-list.show {
            display: block;
        }
        .scene-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .scene-item:hover {
            background-color: rgba(0,0,0,0.1);
        }
        .scene-item.active {
            background-color: rgba(0,0,0,0.2);
            font-weight: bold;
        }
    `;
    document.head.appendChild(style);

    // Create scenes list container
    const scenesList = document.createElement('div');
    scenesList.className = 'scenes-list';
    document.body.appendChild(scenesList);

    // Update scenes list when nodes are set
    const updateScenesList = () => {
        if (!virtualTour) return;
        
        console.log('Updating scenes list...');
        scenesList.innerHTML = '';
        const currentNode = virtualTour.getCurrentNode();

        if (!nodes || nodes.length === 0) {
            console.log('No nodes available');
            return;
        }

        console.log('Found nodes:', nodes);
        nodes.forEach(node => {
            const sceneItem = document.createElement('div');
            sceneItem.className = `scene-item ${node.id === currentNode?.id ? 'active' : ''}`;
            sceneItem.textContent = node.id;
            sceneItem.addEventListener('click', () => {
                virtualTour.setCurrentNode(node.id);
                scenesList.classList.remove('show');
            });
            scenesList.appendChild(sceneItem);
        });
    };

    // Toggle scenes list visibility
    scenesListButton.addEventListener('click', () => {
        scenesList.classList.toggle('show');
        if (scenesList.classList.contains('show')) {
            updateScenesList();
        }
    });

    // Update scenes list when nodes change
    viewer.addEventListener('node-changed', updateScenesList);

    // Wait for the viewer to be ready before setting nodes
    viewer.addEventListener('ready', () => {
        if (virtualTour) {
            virtualTour.setNodes(nodes, 'GF1');
            updateScenesList();
        }
    });

    viewer.addEventListener('click', ({ data }) => {
    const { yaw, pitch, rightclick } = data;
    const currentNode = virtualTour.getCurrentNode();
    
    console.log(`${rightclick ? 'Right-clicked' : 'Clicked'} at:`);
    console.log(`Yaw: ${yaw.toFixed(2)}°`);
    console.log(`Pitch: ${pitch.toFixed(2)}°`);
    
    if (currentNode && currentNode.gps) {
        const [currentLongitude, currentLatitude, currentAltitude] = currentNode.gps;
        console.log(`Current Node GPS Coordinates: Longitude: ${currentLongitude}, Latitude: ${currentLatitude}, Altitude: ${currentAltitude}`);
        
        // Approximate GPS changes based on yaw and pitch
        const deltaLongitude = yaw * 0.1; // Adjust 0.1 to a more suitable scale
        const deltaLatitude = pitch * 0.1; // Adjust 0.1 to a more suitable scale
        
        // Calculate new GPS coordinates based on click
        const newLongitude = currentLongitude + deltaLongitude;
        const newLatitude = currentLatitude + deltaLatitude;
        
        console.log(`Estimated Click GPS Coordinates: Longitude: ${newLongitude.toFixed(6)}, Latitude: ${newLatitude.toFixed(6)}, Altitude: ${currentAltitude}`);
    } else {
        console.log('No GPS data for this node.');
    }
});

    // viewer.addEventListener('click', ({ data }) => {
    //     console.log(`${data.rightclick ? 'right ' : ''}clicked at yaw: ${data.yaw} pitch: ${data.pitch}`);
    // });
</script>
